<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head th:fragment="head">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${pageTitle != null ? pageTitle : 'Multi-Tool System'}"></title>

    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/dataTables.bootstrap5.min.css" />
    <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap5.min.css" />

    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }

        /* Updated body for sticky footer */
        body {
            font-family: Arial, sans-serif;
            background: #f9f9f9;
            overflow-x: hidden;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header - Always full width */
        .header-container {
            background: #025f46;
            color: white;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            z-index: 1000;
        }
        .logo { font-size: 1.5rem; }
        .nav-links { list-style: none; display: flex; gap: 1rem; }
        .nav-links li a { color: white; text-decoration: none; font-weight: bold; }

        /* Hamburger Button - Always visible on ALL screen sizes */
        .hamburger {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            width: 24px;
            height: 18px;
            cursor: pointer;
            transition: transform 0.3s ease;
        }
        .hamburger:hover {
            transform: scale(1.1);
        }
        .hamburger span {
            display: block;
            height: 3px;
            background: white;
            border-radius: 2px;
            transition: all 0.3s ease;
        }

        /* Animated hamburger when sidebar is open */
        .hamburger.active span:nth-child(1) {
            transform: rotate(45deg) translate(5px, 5px);
        }
        .hamburger.active span:nth-child(2) {
            opacity: 0;
        }
        .hamburger.active span:nth-child(3) {
            transform: rotate(-45deg) translate(7px, -6px);
        }

        /* Sidebar - Starts CLOSED on ALL screen sizes */
        .sidebar-menu {
            position: fixed;
            top: 60px;
            left: 0;
            width: 250px;
            height: calc(100% - 60px);
            background: #f4f4f4;
            padding: 1rem;
            list-style: none;
            overflow-y: auto;
            border-right: 1px solid #ddd;
            transform: translateX(-100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 999;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }

        /* IMPORTANT: Force sidebar to show when open class is applied */
        .sidebar-menu.open {
            transform: translateX(0) !important;
        }
        .sidebar-menu li { margin-bottom: 1rem; }
        .sidebar-menu li a {
            text-decoration: none;
            color: #333;
            display: block;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
        }
        .sidebar-menu li a:hover {
            background: #e0e0e0;
            border-left-color: #025f46;
            transform: translateX(5px);
        }

        /* Overlay for mobile/tablet */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 60px;
            left: 0;
            width: 100%;
            height: calc(100% - 60px);
            background: rgba(0, 0, 0, 0.5);
            z-index: 998;
            backdrop-filter: blur(2px);
        }
        .sidebar-overlay.active {
            display: block;
        }

        /* Main Content - Updated for sticky footer */
        .main-content {
            margin-top: 60px;
            margin-left: 0;
            padding: 1.5rem;
            overflow-x: auto;
            position: relative;
            background: #f9f9f9;
            transition: margin-left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            flex: 1; /* This makes the main content take up available space */
        }

        /* Footer - Updated for sticky footer */
        .footer-container {
            background: #025f46;
            color: white;
            text-align: center;
            padding: 0.5rem;
            margin-left: 0;
            transition: margin-left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            margin-top: auto; /* This pushes the footer to the bottom */
        }

        /* When sidebar is open - different behavior for different screen sizes */
        @media (min-width: 1025px) {
            /* Desktop: Push content to the right */
            .main-content.sidebar-open {
                margin-left: 250px;
            }
            .footer-container.sidebar-open {
                margin-left: 250px;
            }
        }

        @media (max-width: 1024px) {
            /* Tablet/Mobile: Sidebar overlays content */
            .nav-links { display: none; }
            .sidebar-menu {
                width: 280px;
            }
            .main-content.sidebar-open {
                margin-left: 0;
            }
            .footer-container.sidebar-open {
                margin-left: 0;
            }
        }

        /* Modern Table Styling */
        .table-container { overflow-x: auto; margin-top: 1rem; }
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        th {
            background: #025f46;
            color: white;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-size: 0.9rem;
        }
        tr:hover { background: #f1f1f1; }

        /* Calendar specific adjustments */
        .calendar-container {
            width: 100%;
            max-width: 100%;
            overflow-x: auto;
        }

        .calendar-grid {
            min-width: 700px;
        }

        .dashboard-container {
            width: 100%;
            max-width: none;
            margin: 0;
            padding: 0;
        }

        .dashboard-content {
            padding: 0 15px 0px; /* Removed bottom padding since footer is now sticky */
            width: 100%;
        }

        /* Status indicator for sidebar state */
        .sidebar-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #025f46;
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            z-index: 1001;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .sidebar-indicator.show {
            opacity: 1;
        }

        @media (max-width: 768px) {
            .main-content {
                padding: 1rem;
            }
            .table-container { overflow-x: auto; }
            table { font-size: 0.85rem; }
        }

        .logout-btn {
            background: none;
            border: none;
            padding: 0;
            margin: 0;
            font-family: inherit;
            font-size: inherit;
            color: inherit;
            text-decoration: none;
            cursor: pointer;
            display: inline;
        }

        /* Make logout button match the link styling */
        .logout-btn:hover {
            text-decoration: underline;
        }

        /* If you have specific link styles, apply them to logout button too */
        .nav-links a,
        .logout-btn {
            /* Add your existing link styles here */
            color: inherit;
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .nav-links a:hover,
        .logout-btn:hover {
            /* Add your existing hover styles here */
            text-decoration: underline;
        }

    </style>
</head>
<body>

<!-- Status indicator -->
<div class="sidebar-indicator" id="sidebarIndicator">Sidebar: Closed</div>

<!-- Sidebar overlay for mobile -->
<div class="sidebar-overlay" id="sidebarOverlay"></div>

<header th:fragment="header">
    <div class="header-container">
        <div class="hamburger" id="hamburgerBtn">
            <span></span>
            <span></span>
            <span></span>
        </div>
        <h1 class="logo">Cicosy Tools</h1>
        <nav>
            <ul class="nav-links">
                <li><a href="/index">Dashboard</a></li>
                <li><a href="/calendar">Calendar</a></li>
                <li>
                    <form th:action="@{/logout}" method="post" style="display: inline; margin: 0;">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                        <button type="submit" class="logout-btn">Logout</button>
                    </form>

                </li>
            </ul>
        </nav>
    </div>
</header>

<aside th:fragment="sidebar">
    <ul class="sidebar-menu" id="sidebarMenu">
        <li><a href="/dashboard" class="nav-item" data-page="dashboard"
               sec:authorize="hasAnyRole('ROLE_USER')">🏠 Dashboard</a></li>
        <li><a href="/admin/user-activity" class="nav-item" data-page="projects"
               sec:authorize="hasRole('ROLE_ADMIN')">🧾User Metadata</a></li>
        <li><a href="/projects" class="nav-item" data-page="projects"
               sec:authorize="hasRole('ROLE_ADMIN')">📁 Projects</a></li>
        <li><a href="/calendar" class="nav-item" data-page="calendar"
               sec:authorize="hasAnyRole('ROLE_ADMIN', 'ROLE_USER')">📅 Calendar</a></li>
        <li><a href="/notification" class="nav-item" data-page="dashboard"
               sec:authorize="hasAnyRole('ROLE_ADMIN')">🔔 Notifications</a></li>
        <li><a href="/contacts" class="nav-item" data-page="dashboard"
               sec:authorize="hasAnyRole('ROLE_ADMIN')">📇 Contacts</a></li>
        <li><a href="/user" class="nav-item" data-page="dashboard"
               sec:authorize="hasAnyRole('ROLE_ADMIN')">📇 Users</a></li>
        <li><a href="/hie" class="nav-item" data-page="dashboard"
               sec:authorize="hasAnyRole('ROLE_ADMIN', 'ROLE_USER')">📤 Data Migration</a></li>
        <li><a href="/names/generate" class="nav-item" data-page="dashboard"
               sec:authorize="hasAnyRole('ROLE_ADMIN', 'ROLE_USER')">💡 Generate Names</a></li>
    </ul>
</aside>

<!-- Example Main Content with Small Table -->
<main class="main-content" id="mainContent">
    <div class="dashboard-container">
        <div class="dashboard-content">
            <h2>Small Table Example</h2>
            <p>This page demonstrates the sticky footer behavior with minimal content.</p>

            <!-- Small table to test footer positioning -->
            <div class="table-container">
                <table>
                    <thead>
                    <tr><th>Name</th><th>Status</th><th>Date</th></tr>
                    </thead>
                    <tbody>
                    <tr><td>Item 1</td><td>Active</td><td>2025-01-01</td></tr>
                    <tr><td>Item 2</td><td>Pending</td><td>2025-01-02</td></tr>
                    <tr><td>Item 3</td><td>Complete</td><td>2025-01-03</td></tr>
                    </tbody>
                </table>
            </div>

            <p style="margin-top: 2rem;">
                Notice how the footer stays at the bottom of the page even though there's minimal content above it.
                Try resizing your browser window or opening/closing the sidebar to see how it behaves.
            </p>
        </div>
    </div>
</main>

<footer th:fragment="footer">
    <div class="footer-container" id="footerContainer">
        <p>&copy; 2025 Multi-Tool System. All rights reserved.</p>
    </div>
</footer>

<!-- JavaScript fragment - include this in your pages -->
<script th:fragment="sidebar-script">
    // DataTables JS (loaded once globally)
    (function loadDataTablesOnce(){
        if (window.__dtLoaded) return; 
        window.__dtLoaded = true;
        const scripts = [
            'https://code.jquery.com/jquery-3.7.1.min.js',
            'https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js',
            'https://cdn.datatables.net/1.13.8/js/dataTables.bootstrap5.min.js',
            'https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js',
            'https://cdn.datatables.net/responsive/2.5.0/js/responsive.bootstrap5.min.js'
        ];
        let i = 0;
        function next(){
            if (i >= scripts.length) { initAllDataTables(); return; }
            const s = document.createElement('script');
            s.src = scripts[i++];
            s.onload = next;
            document.head.appendChild(s);
        }
        next();
    })();

    function initAllDataTables(){
        if (!window.jQuery || !jQuery.fn || !jQuery.fn.DataTable) return;
        jQuery(function(){
            jQuery('table.data-table, table.table.data-table').each(function(){
                const $t = jQuery(this);
                if ($t.data('dt-initialized')) return;
                $t.data('dt-initialized', true);
                $t.DataTable({
                    responsive: true,
                    pageLength: 10,
                    lengthMenu: [10, 25, 50, 100],
                    order: [],
                    language: { search: "Filter:" }
                });
            });
        });
    }
    // Only initialize if not already done
    if (typeof window.sidebarInitialized === 'undefined') {
        window.sidebarInitialized = true;

        let sidebarState = {
            isOpen: false,
            isDesktop: window.innerWidth > 1024
        };

        function updateScreenSize() {
            sidebarState.isDesktop = window.innerWidth > 1024;
        }

        function updateSidebarIndicator() {
            const indicator = document.getElementById('sidebarIndicator');
            if (indicator) {
                indicator.textContent = `Sidebar: ${sidebarState.isOpen ? 'Open' : 'Closed'}`;
                indicator.classList.add('show');

                setTimeout(() => {
                    indicator.classList.remove('show');
                }, 2000);
            }
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebarMenu');
            const mainContent = document.getElementById('mainContent');
            const footer = document.getElementById('footerContainer');
            const overlay = document.getElementById('sidebarOverlay');
            const hamburger = document.getElementById('hamburgerBtn');

            // Check if essential elements exist
            if (!sidebar) {
                console.error('Sidebar element not found!');
                return;
            }

            console.log('Toggle sidebar called. Current state:', sidebarState.isOpen);

            // Toggle sidebar state
            sidebarState.isOpen = !sidebarState.isOpen;

            console.log('New state:', sidebarState.isOpen);

            // Update hamburger animation
            if (hamburger) {
                hamburger.classList.toggle('active', sidebarState.isOpen);
            }

            // Apply sidebar toggle
            if (sidebarState.isOpen) {
                sidebar.classList.add('open');
                console.log('Added open class to sidebar');
            } else {
                sidebar.classList.remove('open');
                console.log('Removed open class from sidebar');
            }

            if (sidebarState.isDesktop) {
                // Desktop behavior: Push content
                if (mainContent) {
                    mainContent.classList.toggle('sidebar-open', sidebarState.isOpen);
                }
                if (footer) {
                    footer.classList.toggle('sidebar-open', sidebarState.isOpen);
                }

                // No overlay on desktop
                if (overlay) {
                    overlay.classList.remove('active');
                }
                document.body.style.overflow = '';
            } else {
                // Mobile/Tablet behavior: Overlay
                if (sidebarState.isOpen) {
                    if (overlay) {
                        overlay.classList.add('active');
                    }
                    document.body.style.overflow = 'hidden';
                } else {
                    if (overlay) {
                        overlay.classList.remove('active');
                    }
                    document.body.style.overflow = '';
                }

                // Don't push content on mobile
                if (mainContent) {
                    mainContent.classList.remove('sidebar-open');
                }
                if (footer) {
                    footer.classList.remove('sidebar-open');
                }
            }

            // Update indicator
            updateSidebarIndicator();

            // Store state in sessionStorage for persistence across page loads
            sessionStorage.setItem('sidebarOpen', sidebarState.isOpen);

            // Debug: Check if sidebar has the open class
            console.log('Sidebar classes:', sidebar.classList.toString());
        }

        function closeSidebar() {
            if (sidebarState.isOpen) {
                toggleSidebar();
            }
        }

        function initializeSidebar() {
            updateScreenSize();

            // Check if there's a stored sidebar state
            const storedState = sessionStorage.getItem('sidebarOpen');
            if (storedState === 'true') {
                sidebarState.isOpen = false;
                toggleSidebar();
            }
        }

        // Handle window resize
        window.addEventListener('resize', function() {
            const wasDesktop = sidebarState.isDesktop;
            updateScreenSize();

            if (wasDesktop !== sidebarState.isDesktop) {
                const sidebar = document.getElementById('sidebarMenu');
                const mainContent = document.getElementById('mainContent');
                const footer = document.getElementById('footerContainer');
                const overlay = document.getElementById('sidebarOverlay');

                if (sidebarState.isDesktop) {
                    if (overlay) overlay.classList.remove('active');
                    document.body.style.overflow = '';

                    if (sidebarState.isOpen) {
                        if (mainContent) mainContent.classList.add('sidebar-open');
                        if (footer) footer.classList.add('sidebar-open');
                    }
                } else {
                    if (mainContent) mainContent.classList.remove('sidebar-open');
                    if (footer) footer.classList.remove('sidebar-open');

                    if (sidebarState.isOpen) {
                        if (overlay) overlay.classList.add('active');
                        document.body.style.overflow = 'hidden';
                    }
                }
            }
        });

        // Close sidebar when clicking outside (mobile/tablet only)
        document.addEventListener('click', function (e) {
            if (sidebarState.isDesktop) return;

            const sidebar = document.getElementById('sidebarMenu');
            const hamburger = document.getElementById('hamburgerBtn');

            if (sidebar && hamburger &&
                !sidebar.contains(e.target) &&
                !hamburger.contains(e.target) &&
                sidebarState.isOpen) {
                closeSidebar();
            }
        });

        // Keyboard support
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && sidebarState.isOpen) {
                closeSidebar();
            }

            if ((e.ctrlKey || e.metaKey) && e.key === 'b') {
                e.preventDefault();
                toggleSidebar();
            }
        });

        // Add click event to hamburger button and overlay
        function attachEvents() {
            const hamburgerBtn = document.getElementById('hamburgerBtn');
            if (hamburgerBtn) {
                hamburgerBtn.addEventListener('click', toggleSidebar);
            }

            const overlay = document.getElementById('sidebarOverlay');
            if (overlay) {
                overlay.addEventListener('click', closeSidebar);
            }
        }

        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                attachEvents();
                initializeSidebar();
            });
        } else {
            // DOM is already loaded
            attachEvents();
            initializeSidebar();
        }

        // Expose utility functions
        window.sidebarUtils = {
            toggle: toggleSidebar,
            close: closeSidebar,
            isOpen: () => sidebarState.isOpen,
            isDesktop: () => sidebarState.isDesktop
        };
    }
</script>

</body>
</html>